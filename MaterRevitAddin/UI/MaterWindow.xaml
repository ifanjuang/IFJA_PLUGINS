<Window x:Class="Mater2026.UI.MaterWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Mater 2026" Width="1280" Height="860"
        WindowStartupLocation="CenterOwner">


    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="Bool2Vis"/>

        <!-- Folder tile -->
        <DataTemplate x:Key="FolderTileTemplate">
            <Border Margin="6" Padding="6" BorderBrush="#555" BorderThickness="1" CornerRadius="8"
                    ContextMenuOpening="FolderTile_ContextMenuOpening">
                <StackPanel>
                    <Border Background="#111" Width="160" Height="160" CornerRadius="6">
                        <Image Stretch="UniformToFill" Source="{Binding ThumbPath}"/>
                    </Border>
                    <TextBlock Text="{Binding Name}" HorizontalAlignment="Center" Margin="0,4,0,0"/>
                </StackPanel>
            </Border>
        </DataTemplate>

        <!-- File tile (overlay) -->
        <DataTemplate x:Key="FileTileTemplate">
            <Border Margin="6" Padding="6" BorderBrush="#444" BorderThickness="1" CornerRadius="6">
                <StackPanel>
                    <Image Width="120" Height="120" Stretch="UniformToFill"
                           Source="{Binding FullPath}"
                           Tag="{Binding FullPath}"
                           MouseLeftButtonDown="ImageItem_MouseLeftButtonDown"
                           PreviewMouseMove="ImageItem_PreviewMouseMove"
                           ContextMenuOpening="ImageItem_ContextMenuOpening"/>
                    <TextBlock Text="{Binding FileName}" HorizontalAlignment="Center" Margin="0,6,0,0"/>
                </StackPanel>
            </Border>
        </DataTemplate>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="200"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="200"/>
        </Grid.ColumnDefinitions>

        <!-- ========== LEFT COLUMN ========== -->
        <DockPanel Grid.Column="0" Margin="5">
            <!-- Root picker + Tree -->
            <StackPanel Margin="0,0,0,8" Orientation="Vertical">
                <TextBlock FontWeight="Bold" Text="Library" Height="20"/>
                <StackPanel Orientation="Horizontal" Height="20">
                    <Button x:Name="BtnPickRoot" Content="Folder" Click="BtnPickRoot_Click"
                            BorderBrush="{x:Null}" Background="{x:Null}" Padding="0"/>
                    <TextBox x:Name="RootBox" Margin="6,0,0,0" IsReadOnly="True"
                             BorderThickness="0" Width="137"/>
                </StackPanel>

                <TreeView x:Name="Tree"
                          Height="300"
                          SelectedItemChanged="Tree_SelectedItemChanged"
                          VirtualizingStackPanel.IsVirtualizing="True"
                          VirtualizingStackPanel.VirtualizationMode="Recycling"
                          ScrollViewer.CanContentScroll="True"
                          BorderBrush="#FF005BFF" Padding="1,1,1,10"/>

                <TextBlock Text="Project Material List" FontWeight="Bold"/>
                <!-- If ItemsSource = tuple: use DisplayMemberPath="Item2" SelectedValuePath="Item1" -->
                <TextBox Margin="0,6,0,4"
                    Text="{Binding MaterialFilter, UpdateSourceTrigger=PropertyChanged}">
                    <TextBox.ToolTip>Filter materials (contains)</TextBox.ToolTip>
                </TextBox>

                <ListBox x:Name="MatList"
                 ItemsSource="{Binding ProjectMaterials}"
                 DisplayMemberPath="Name"
                 SelectedValuePath="Id"
                 ScrollViewer.CanContentScroll="True"
                 VirtualizingPanel.IsVirtualizing="True"
                 VirtualizingPanel.VirtualizationMode="Recycling"
                 Height="400">

                    <!-- Context menu per item -->
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="ContextMenu">
                                <Setter.Value>
                                    <ContextMenu>
                                        <MenuItem Header="Retrieve parameters"
                      Command="{Binding DataContext.RetrieveParamsCmd, RelativeSource={RelativeSource AncestorType=ListBox}}"
                      CommandParameter="{Binding}"/>
                                    </ContextMenu>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>

                    <!-- Click anywhere on the item to toggle selection -->
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border Padding="6" Margin="4" BorderBrush="#444" BorderThickness="1" CornerRadius="6">
                                <Grid>
                                    <TextBlock Text="{Binding Name}" />
                                    <Button Command="{Binding DataContext.ToggleSelectMaterialCmd, RelativeSource={RelativeSource AncestorType=ListBox}}"
                  CommandParameter="{Binding}"
                  Opacity="0" Background="Transparent" BorderThickness="0"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>


                <Button x:Name="PipetteBtn" Content="Pick" Click="PipetteBtn_Click" Width="100"/>
                <Button x:Name="AssignBtn" Content="Assign" Click="AssignBtn_Click"
                        IsEnabled="False" Width="100"/>
            </StackPanel>
        </DockPanel>

        <!-- ========== CENTER COLUMN ========== -->
        <DockPanel Grid.Column="1" Margin="5">
            <!-- Toolbar -->
            <StackPanel DockPanel.Dock="Top" Height="40">
                <TextBlock FontWeight="Bold" HorizontalAlignment="Left" Height="20">
                    <Run Language="fr-fr" Text="Thumbnails"/>
                </TextBlock>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,6" Width="331" Height="20">
                    <ComboBox x:Name="ThumbSizeDrop"
                              SelectionChanged="ThumbSizeDrop_SelectionChanged"
                              Width="100" Padding="0" BorderThickness="0" BorderBrush="{x:Null}"/>
                    <Button x:Name="GenMissing" Content="Generate" Click="GenMissing_Click"
                            Background="{x:Null}" BorderBrush="{x:Null}"/>
                    <ToggleButton x:Name="ToggleGalleryBtn" Content="Galerie ↔ Thumbnails" Margin="12,0,0,0"
                                  Click="ToggleGallery_Click" Visibility="Collapsed"/>
                </StackPanel>
            </StackPanel>
            
            <ScrollViewer DockPanel.Dock="Top"
              HorizontalScrollBarVisibility="Disabled"
              VerticalScrollBarVisibility="Auto">
                <ItemsControl x:Name="GridFoldersPanel"
                ItemsSource="{Binding GridFolders}"
                ItemTemplate="{StaticResource FolderTileTemplate}"
                PreviewMouseLeftButtonUp="GridFoldersPanel_PreviewMouseLeftButtonUp"
                PreviewMouseRightButtonUp="GridFoldersPanel_PreviewMouseRightButtonUp" Height="628">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
            </ScrollViewer>

            <Border x:Name="FilesOverlay"
                    DockPanel.Dock="Top"
                    Background="#D0151515"
                    Padding="10"
                    Visibility="Collapsed">
                <StackPanel>
                    <DockPanel Margin="0,0,0,8">
                        <TextBlock Text="{Binding ElementName=FilesList, Path=Items.Count, StringFormat=Fichiers ({0})}"
                                   FontWeight="Bold" VerticalAlignment="Center"/>
                        <Button Content="Fermer" DockPanel.Dock="Right"
                                Click="FilesOverlay_Close_Click" Padding="6,2" Margin="8,0,0,0"/>
                    </DockPanel>

                    <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto" Height="220">
                        <ItemsControl x:Name="FilesList" ItemTemplate="{StaticResource FileTileTemplate}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </ScrollViewer>
                </StackPanel>
            </Border>

        </DockPanel>

        <!-- ========== RIGHT COLUMN ========== -->
        <StackPanel Grid.Column="2" Margin="5" HorizontalAlignment="Right">
            <TextBlock Text="Appearence" FontWeight="Bold" Height="20"/>

            <TextBlock Text="Maps" Height="20"/>
            <!-- RIGHT COLUMN -->
            <ItemsControl x:Name="MapTypesList" Grid.Column="2" Margin="5" Height="439">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Margin="0,0,0,8"
              Padding="0,0,0,8"
              BorderBrush="#333"
              BorderThickness="0,0,0,1"
              HorizontalAlignment="Stretch"
              AllowDrop="True"
              DragOver="MapSlot_DragOver"
              Drop="MapSlot_Drop"
              ContextMenuOpening="MapSlot_ContextMenuOpening">
                            <StackPanel>
                                <TextBlock Text="{Binding DisplayName}"
                     FontWeight="Bold"
                     Margin="0,0,0,6"/>
                                <Border Height="100" Background="#111">
                                    <Image Stretch="UniformToFill"
                   Source="{Binding Assigned.FullPath}"/>
                                </Border>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <Button x:Name="TintBtn" Content="Tint" Width="190" Click="TintBtn_Click" Height="20" BorderBrush="Black" Background="White"/>
            <TextBlock Text="Name" Margin="0,6,0,0"/>
            <TextBox x:Name="MatNameBox" TextChanged="MatNameBox_TextChanged"
                     VerticalAlignment="Center" BorderBrush="Black" BorderThickness="0,0,0,1"/>

            <TextBlock Text="Path" Margin="0,20,0,0"/>
            <TextBox x:Name="FolderBox" IsReadOnly="True" BorderThickness="0,0,0,1" BorderBrush="Black"/>

            <StackPanel Orientation="Horizontal" Margin="0,20,0,0">
                <StackPanel Width="95">
                    <TextBlock Text="X(cm)"/>
                    <TextBox x:Name="WidthBox" Text="300" BorderThickness="0,0,0,1" BorderBrush="Black"/>
                </StackPanel>
                <StackPanel Width="95">
                    <TextBlock Text="Y(cm)"/>
                    <TextBox x:Name="HeightBox" Text="300" BorderThickness="0,0,0,1" BorderBrush="Black"/>
                </StackPanel>
            </StackPanel>

            <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                <StackPanel Width="95">
                    <TextBlock Text="Tiles X"/>
                    <TextBox x:Name="TilesXBox" Text="1" BorderThickness="1,1,0,1"/>
                </StackPanel>
                <StackPanel Width="95">
                    <TextBlock Text="Tiles Y"/>
                    <TextBox x:Name="TilesYBox" Text="1" BorderThickness="0,1,1,1"/>
                </StackPanel>
            </StackPanel>

            <TextBlock Text="Rotation (°)" Margin="0,6,0,0"/>
            <TextBox x:Name="RotBox" Text="0"/>

            <StackPanel Margin="0,10,0,0" Orientation="Horizontal">
                <Button x:Name="Create"  Content="Create"     Width="90" Click="CreateBtn_Click"/>
                <Button x:Name="Replace"
        Content="Replace"
        Width="90"
        Margin="8,0,0,0"
        Click="ReplaceBtn_Click"
        Visibility="{Binding HasSelectedMaterial, Converter={StaticResource Bool2Vis}}"/>
            </StackPanel>
        </StackPanel>
    </Grid>
</Window>
